generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  user_id                      String                       @id @default(uuid()) @db.Uuid
  email                        String                       @unique
  password_hash                String
  role                         user_role_enum
  created_at                   DateTime                     @default(now())
  updated_at                   DateTime                     @updatedAt
  booked_appointments          appointments[]
  availability_slots           availability_slots[]
  doctor_profile               doctor_profiles?
  family_profile               family_profiles?
  meal_logs                    meal_logs[]
  adherence_logs               medication_adherence_logs[]
  nutrition_updates            nutrition_profiles[]
  care_team_links              patient_care_team[]
  snapshots                    patient_progress_snapshots[]
  prescriptions                prescriptions[]
  progress_logs                progress_logs[]
  therapist_profile            therapist_profiles?
  patient_medications          patient_medication_catalogs[]
  medication_adherence_logs_v2 medication_adherence_logs_v2[]
  patient_exercises            patient_exercise_catalogs[]
  exercise_adherence_logs      exercise_adherence_logs[]
  patient_foods                patient_nutrition_catalogs[]
  nutrition_adherence_logs     nutrition_adherence_logs[]

  @@map("users")
}

model doctor_profiles {
  doctor_profile_id String                     @id @default(uuid()) @db.Uuid
  user_id           String                     @unique @db.Uuid
  first_name        String
  last_name         String
  medical_license   String                     @unique
  specialization    doctor_specialization_enum
  hospital_name     String?
  contact_number    String?
  user              users                      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("doctor_profiles")
}

model therapist_profiles {
  therapist_profile_id String                        @id @default(uuid()) @db.Uuid
  user_id              String                        @unique @db.Uuid
  first_name           String
  last_name            String
  medical_license      String                        @unique
  specialization       therapist_specialization_enum
  hospital_name        String?
  contact_number       String?
  user                 users                         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("therapist_profiles")
}

model family_profiles {
  family_profile_id String       @id @default(uuid()) @db.Uuid
  user_id           String       @unique @db.Uuid
  first_name        String
  last_name         String
  gender            gender_enum?
  home_address      String?
  contact_number    String?
  user              users        @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("family_profiles")
}

model patient_profiles {
  patient_id                String    @id @default(uuid()) @db.Uuid
  name                      String
  date_of_birth             DateTime  @db.Date
  gender                    gender_enum?
  medical_history           String?
  unique_code               String    @unique @db.VarChar(20) // Format: PASIEN-XXXXXX
  created_at                DateTime  @default(now())
  updated_at                DateTime  @updatedAt
  documents                 Json?

  // --- Relasi (Hal-hal yang "Dimiliki" Pasien) ---
  care_team_links           patient_care_team[]
  appointments              appointments[]
  prescriptions             prescriptions[]
  adherence_logs            medication_adherence_logs[]
  nutrition_profile         nutrition_profiles? // Relasi 1-ke-1
  meal_logs                 meal_logs[]
  snapshots                 patient_progress_snapshots[]
  progress_logs             progress_logs[]
  patient_medications       patient_medication_catalogs[]
  medication_adherence_logs_v2 medication_adherence_logs_v2[]
  patient_exercises         patient_exercise_catalogs[]
  exercise_adherence_logs   exercise_adherence_logs[]
  patient_foods             patient_nutrition_catalogs[]
  nutrition_adherence_logs  nutrition_adherence_logs[]

  @@map("patient_profiles")
}

model patient_care_team {
  link_id    String           @id @default(uuid()) @db.Uuid
  user_id    String           @db.Uuid
  patient_id String           @db.Uuid
  patient    patient_profiles @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  user       users            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, patient_id])
  @@map("patient_care_team")
}

model availability_slots {
  slot_id         String        @id @default(uuid()) @db.Uuid
  medical_user_id String        @db.Uuid
  start_time      DateTime      @db.Timestamp(6)
  end_time        DateTime      @db.Timestamp(6)
  is_booked       Boolean       @default(false)
  appointment     appointments?
  medical_user    users         @relation(fields: [medical_user_id], references: [user_id], onDelete: Cascade)

  @@unique([medical_user_id, start_time])
  @@map("availability_slots")
}

model appointments {
  appointment_id    String                  @id @default(uuid()) @db.Uuid
  slot_id           String                  @unique @db.Uuid
  patient_id        String                  @db.Uuid
  booked_by_user_id String                  @db.Uuid
  status            appointment_status_enum @default(scheduled)
  created_at        DateTime                @default(now())
  booked_by_user    users                   @relation(fields: [booked_by_user_id], references: [user_id], onDelete: Cascade)
  patient           patient_profiles        @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  slot              availability_slots      @relation(fields: [slot_id], references: [slot_id], onDelete: Cascade)

  @@map("appointments")
}

model prescriptions {
  prescription_id   String                      @id @default(uuid()) @db.Uuid
  patient_id        String                      @db.Uuid
  doctor_user_id    String                      @db.Uuid
  medication_name   String
  dosage            String
  instructions      String?
  frequency_per_day Int
  dosing_times      String[]
  start_date        DateTime                    @db.Date
  end_date          DateTime?                   @db.Date
  is_active         Boolean                     @default(true)
  created_at        DateTime                    @default(now())
  updated_at        DateTime                    @updatedAt
  adherence_logs    medication_adherence_logs[]
  doctor            users                       @relation(fields: [doctor_user_id], references: [user_id], onDelete: SetNull)
  patient           patient_profiles            @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)

  @@map("prescriptions")
}

model medication_adherence_logs {
  adherence_id      String                           @id @default(uuid()) @db.Uuid
  prescription_id   String                           @db.Uuid
  patient_id        String                           @db.Uuid
  logged_by_user_id String                           @db.Uuid
  status            medication_adherence_status_enum
  scheduled_time    DateTime?                        @db.Timestamp(6)
  taken_time        DateTime?                        @db.Timestamp(6)
  notes             String?
  created_at        DateTime                         @default(now())
  logged_by_user    users                            @relation(fields: [logged_by_user_id], references: [user_id], onDelete: SetNull)
  patient           patient_profiles                 @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  prescription      prescriptions                    @relation(fields: [prescription_id], references: [prescription_id], onDelete: Cascade)

  @@map("medication_adherence_logs")
}

model nutrition_profiles {
  patient_id         String           @id @db.Uuid
  calorie_target_min Int              @default(1400)
  calorie_target_max Int              @default(1800)
  sodium_limit_mg    Int              @default(1500)
  fiber_target_g     Int              @default(25)
  fluid_limit_ml     Int              @default(2000)
  updated_by_user_id String           @db.Uuid
  updated_at         DateTime         @updatedAt
  patient            patient_profiles @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  updated_by_user    users            @relation(fields: [updated_by_user_id], references: [user_id], onDelete: SetNull)

  @@map("nutrition_profiles")
}

model meal_logs {
  meal_id           String           @id @default(uuid()) @db.Uuid
  patient_id        String           @db.Uuid
  logged_by_user_id String           @db.Uuid
  meal_type         meal_type_enum
  foods             String[]
  sodium_mg         Int              @default(0)
  calories          Int              @default(0)
  fiber_g           Int              @default(0)
  logged_for        DateTime         @db.Date
  created_at        DateTime         @default(now())
  logged_by_user    users            @relation(fields: [logged_by_user_id], references: [user_id], onDelete: Cascade)
  patient           patient_profiles @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)

  @@map("meal_logs")
}

model patient_progress_snapshots {
  entry_id                 String           @id @default(uuid()) @db.Uuid
  patient_id               String           @db.Uuid
  recorded_by_user_id      String           @db.Uuid
  recorded_at              DateTime         @db.Timestamp(6)
  mood                     String?
  symptom_score            Int?
  mobility_score           Int?
  exercise_completed       Boolean?
  blood_pressure_systolic  Int?
  blood_pressure_diastolic Int?
  notes                    String?
  created_at               DateTime         @default(now())
  patient                  patient_profiles @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  recorded_by_user         users            @relation(fields: [recorded_by_user_id], references: [user_id], onDelete: Cascade)

  @@map("patient_progress_snapshots")
}

model progress_logs {
  log_id         String           @id @default(uuid()) @db.Uuid
  patient_id     String           @db.Uuid
  author_user_id String           @db.Uuid
  author_role    author_role_enum
  log_text       String
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  author_user    users            @relation(fields: [author_user_id], references: [user_id], onDelete: Cascade)
  patient        patient_profiles @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)

  @@map("progress_logs")
}

model medication_interactions {
  interaction_id String @id @default(uuid()) @db.Uuid
  medication_a   String
  medication_b   String
  severity       String
  description    String

  @@unique([medication_a, medication_b])
  @@map("medication_interactions")
}

model medication_catalogs {
  catalog_id         String                        @id @default(uuid()) @db.Uuid
  medication_name    String
  description        String
  dosage_standard    String
  side_effects       String?
  contraindications  String?
  image_url          String?
  manufacturer       String?
  registration_no    String?
  product_category   String? // Golongan produk
  created_at         DateTime                      @default(now())
  patient_medications patient_medication_catalogs[]

  @@map("medication_catalogs")
}

model patient_medication_catalogs {
  patient_med_id  String               @id @default(uuid()) @db.Uuid
  patient_id      String               @db.Uuid
  catalog_id      String               @db.Uuid
  doctor_user_id  String               @db.Uuid
  prescribed_date DateTime             @default(now())
  created_at      DateTime             @default(now())
  patient         patient_profiles     @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  medication      medication_catalogs  @relation(fields: [catalog_id], references: [catalog_id], onDelete: Cascade)
  doctor_user     users                @relation(fields: [doctor_user_id], references: [user_id], onDelete: SetNull)
  adherence_logs  medication_adherence_logs_v2[]

  @@unique([patient_id, catalog_id])
  @@map("patient_medication_catalogs")
}

model medication_adherence_logs_v2 {
  adherence_id       String                        @id @default(uuid()) @db.Uuid
  patient_med_id     String                        @db.Uuid
  patient_id         String                        @db.Uuid
  logged_by_user_id  String                        @db.Uuid
  status             medication_adherence_status_enum
  scheduled_time     DateTime?                     @db.Timestamp(6)
  taken_time         DateTime?                     @db.Timestamp(6)
  notes              String?
  created_at         DateTime                      @default(now())
  logged_by_user     users                         @relation(fields: [logged_by_user_id], references: [user_id], onDelete: SetNull)
  patient            patient_profiles              @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  patient_medication patient_medication_catalogs   @relation(fields: [patient_med_id], references: [patient_med_id], onDelete: Cascade)

  @@map("medication_adherence_logs_v2")
}

model exercise_catalogs {
  catalog_id       String                     @id @default(uuid()) @db.Uuid
  exercise_name    String
  description      String
  specialization   therapist_specialization_enum
  frequency_per_day Int
  duration_minutes Int?
  image_url        String?
  tutorial_url     String?
  instructions     String?
  created_at       DateTime                   @default(now())
  patient_exercises patient_exercise_catalogs[]

  @@map("exercise_catalogs")
}

model patient_exercise_catalogs {
  patient_ex_id    String                @id @default(uuid()) @db.Uuid
  patient_id       String                @db.Uuid
  catalog_id       String                @db.Uuid
  therapist_user_id String               @db.Uuid
  prescribed_date  DateTime              @default(now())
  created_at       DateTime              @default(now())
  patient          patient_profiles      @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  exercise         exercise_catalogs     @relation(fields: [catalog_id], references: [catalog_id], onDelete: Cascade)
  therapist_user   users                 @relation(fields: [therapist_user_id], references: [user_id], onDelete: SetNull)
  adherence_logs   exercise_adherence_logs[]

  @@unique([patient_id, catalog_id])
  @@map("patient_exercise_catalogs")
}

model exercise_adherence_logs {
  adherence_id      String                @id @default(uuid()) @db.Uuid
  patient_ex_id     String                @db.Uuid
  patient_id        String                @db.Uuid
  logged_by_user_id String                @db.Uuid
  status            exercise_adherence_status_enum @default(taken)
  scheduled_date    DateTime?             @db.Date
  actual_date       DateTime?             @db.Date
  notes             String?
  created_at        DateTime              @default(now())
  logged_by_user    users                 @relation(fields: [logged_by_user_id], references: [user_id], onDelete: SetNull)
  patient           patient_profiles      @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  patient_exercise  patient_exercise_catalogs @relation(fields: [patient_ex_id], references: [patient_ex_id], onDelete: Cascade)

  @@map("exercise_adherence_logs")
}

model nutrition_food_catalogs {
  catalog_id       String               @id @default(uuid()) @db.Uuid
  food_name        String
  description      String
  food_category    nutrition_food_category_enum
  meal_type        meal_type_enum
  image_url        String?
  calories         Int?
  sodium_mg        Int?
  fiber_g          Int?
  created_at       DateTime             @default(now())
  patient_foods    patient_nutrition_catalogs[]

  @@map("nutrition_food_catalogs")
}

model patient_nutrition_catalogs {
  patient_food_id  String              @id @default(uuid()) @db.Uuid
  patient_id       String              @db.Uuid
  catalog_id       String              @db.Uuid
  doctor_user_id   String              @db.Uuid
  prescribed_date  DateTime            @default(now())
  created_at       DateTime            @default(now())
  patient          patient_profiles    @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  food             nutrition_food_catalogs @relation(fields: [catalog_id], references: [catalog_id], onDelete: Cascade)
  doctor_user      users               @relation(fields: [doctor_user_id], references: [user_id], onDelete: SetNull)
  adherence_logs   nutrition_adherence_logs[]

  @@unique([patient_id, catalog_id])
  @@map("patient_nutrition_catalogs")
}

model nutrition_adherence_logs {
  adherence_id      String              @id @default(uuid()) @db.Uuid
  patient_food_id   String              @db.Uuid
  patient_id        String              @db.Uuid
  logged_by_user_id String              @db.Uuid
  status            nutrition_adherence_status_enum @default(taken)
  scheduled_date    DateTime?           @db.Date
  actual_date       DateTime?           @db.Date
  notes             String?
  created_at        DateTime            @default(now())
  logged_by_user    users               @relation(fields: [logged_by_user_id], references: [user_id], onDelete: SetNull)
  patient           patient_profiles    @relation(fields: [patient_id], references: [patient_id], onDelete: Cascade)
  patient_food      patient_nutrition_catalogs @relation(fields: [patient_food_id], references: [patient_food_id], onDelete: Cascade)

  @@map("nutrition_adherence_logs")
}

enum gender_enum {
  MALE
  FEMALE
}

enum doctor_specialization_enum {
  NEUROLOGIST
  PHYSIATRIST
}

enum therapist_specialization_enum {
  PHYSICAL
  OCCUPATIONAL
  RECREATIONAL
  SPEECH
  PSYCHOLOGIST
  DIETITIAN
}

enum user_role_enum {
  doctor
  therapist
  family
}

enum author_role_enum {
  family
  medical
}

enum appointment_status_enum {
  scheduled
  completed
  canceled
}

enum medication_adherence_status_enum {
  taken
  missed
  delayed
}

enum exercise_adherence_status_enum {
  taken
  missed
}

enum nutrition_adherence_status_enum {
  taken
  missed
}

enum nutrition_food_category_enum {
  vegetable
  main_course
  snack
  beverages
}

enum meal_type_enum {
  breakfast
  lunch
  dinner
  snack
}
